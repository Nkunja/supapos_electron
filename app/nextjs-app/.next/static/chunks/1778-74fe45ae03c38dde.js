"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1778],{61778:(e,n,t)=>{t.d(n,{As:()=>O,R4:()=>D,default:()=>C,w2:()=>A});var a=t(23464),r=t(29159),s=t(12115),u=t(35695);let l="".concat("https://supa.sirnkunja.co.ke/","api"),o=a.A.create({baseURL:l,headers:{"Content-Type":"application/json"},timeout:5e3}),i=null,c=null,d=null,m=!0,f=!1,p=null,h=(e,n,t)=>{if("undefined"!=typeof document){let a=new Date(Date.now()+1e3*t).toUTCString();document.cookie="".concat(e,"=").concat(encodeURIComponent(n),"; expires=").concat(a,"; path=/; secure; samesite=strict;")}},v=e=>{if("undefined"!=typeof document){let n="; ".concat(document.cookie).split("; ".concat(e,"="));if(2===n.length){let e=n.pop();return e?decodeURIComponent(e.split(";").shift()||""):null}}return null},w=e=>{"undefined"!=typeof document&&(document.cookie="".concat(e,"=; Max-Age=-99999999; path=/;"))},g=e=>{if(!e)return!1;try{let n=(0,r.s)(e);return 1e3*n.exp>Date.now()+1e4}catch(e){return!1}},y=()=>{i=null,c=null,d=null,w("access_token"),w("refresh_token"),w("user_info")},E=e=>{switch(e.toLowerCase()){case"admin":return"/admin";case"supervisor":return"/supervisor";default:return"/sales"}};(()=>{let e=v("access_token"),n=v("refresh_token"),t=v("user_info");if(e&&g(e)&&(i=e),n&&g(n)&&(c=n),t)try{d=JSON.parse(t)}catch(e){w("user_info")}})();let k=async()=>{if(!i||!g(i))return d;try{let e=await o.get("/users/me/",{headers:{Authorization:"Bearer ".concat(i)}});m=!0,f=!1,p=null,Date.now();let n=e.data;return d=n,h("user_info",JSON.stringify(n),604800),n}catch(u){var e,n,t,a,r,s;return"ECONNABORTED"===u.code||"ERR_NETWORK"===u.code||(null==(e=u.message)?void 0:e.includes("timeout"))||(null==(n=u.message)?void 0:n.includes("Network Error"))||!u.response?(m=!1,Date.now()):(null==(t=u.response)?void 0:t.status)===503&&(m=!0,f=!0,p=(null==(r=u.response)||null==(a=r.data)?void 0:a.maintenance)||(null==(s=u.response)?void 0:s.data)||null,Date.now()),d}},_=async(e,n)=>{try{let t=await S();if(t.maintenanceMode||t.serverError)return t;let a=(await o.post("/auth/login/",{email:e,password:n})).data;return m=!0,f=!1,p=null,Date.now(),"Login successful"===a.message&&a.tokens&&((e,n,t)=>{i=e,c=n,h("access_token",e,7200),h("refresh_token",n,604800),t&&(d=t,h("user_info",JSON.stringify(t),604800))})(a.tokens.access,a.tokens.refresh,a.user),a}catch(e){var t,a,r,s,u,l,v,w;if("ECONNABORTED"===e.code||"ERR_NETWORK"===e.code||(null==(t=e.message)?void 0:t.includes("timeout"))||(null==(a=e.message)?void 0:a.includes("Network Error"))||!e.response)return m=!1,Date.now(),{message:"Server currently unreachable. Please check your connection and try again.",isAuthenticated:!1,serverError:!0};if((null==(r=e.response)?void 0:r.status)===503)return m=!0,f=!0,p=(null==(v=e.response)||null==(l=v.data)?void 0:l.maintenance)||(null==(w=e.response)?void 0:w.data)||null,Date.now(),{message:"Server is currently under maintenance.",isAuthenticated:!1,maintenanceMode:!0,maintenanceInfo:p};return{message:(null==(u=e.response)||null==(s=u.data)?void 0:s.message)||"Login failed",isAuthenticated:!1}}},R=async()=>{try{await o.post("/auth/logout/",{refresh_token:c},{headers:{Authorization:"Bearer ".concat(i)}})}catch(e){}finally{y(),window.location.href="/login"}},A=async e=>{try{let{data:n}=await o.post("/auth/password-reset/",{email:e});return{success:!0,message:(null==n?void 0:n.message)||"Password reset email sent successfully."}}catch(e){var n,t,a,r;return{success:!1,message:(null==e||null==(t=e.response)||null==(n=t.data)?void 0:n.message)||(null==e||null==(r=e.response)||null==(a=r.data)?void 0:a.detail)||"Failed to send reset email. Please try again."}}},D=async(e,n,t,a)=>{try{let r=await o.post("/auth/password-reset/confirm/",{uid:e,token:n,new_password:t,confirm_password:a});return{success:!0,message:r.data.message}}catch(e){var r,s;return{success:!1,message:(null==e||null==(s=e.response)||null==(r=s.data)?void 0:r.message)||"Failed to reset password. Please try again."}}},N=()=>!!(i&&g(i)),S=async()=>{try{let e=await a.A.get("".concat(l,"/health/"),{timeout:3e3,headers:{"Content-Type":"application/json"}});return m=!0,f="maintenance"===e.data.status,p="maintenance"===e.data.status&&e.data.maintenance||null,Date.now(),{message:f?"Server is in maintenance mode":"Server is reachable",isAuthenticated:N(),serverError:!1,maintenanceMode:f,maintenanceInfo:p}}catch(a){var e,n,t,r;if(Date.now(),(null==(e=a.response)?void 0:e.status)===503)return m=!0,f=!0,p=(null==(t=a.response)||null==(n=t.data)?void 0:n.maintenance)||(null==(r=a.response)?void 0:r.data)||null,{message:"Server is in maintenance mode",isAuthenticated:N(),serverError:!1,maintenanceMode:!0,maintenanceInfo:p};return m=!1,f=!1,p=null,{message:"Server is unreachable",isAuthenticated:N(),serverError:!0,maintenanceMode:!1}}};o.interceptors.request.use(e=>(i&&g(i)&&(e.headers.Authorization="Bearer ".concat(i)),e),e=>Promise.reject(e)),o.interceptors.response.use(e=>(m=!0,f=!1,p=null,Date.now(),e),async e=>{var n,t,a,r,s;if("ECONNABORTED"===e.code||"ERR_NETWORK"===e.code||(null==(n=e.message)?void 0:n.includes("timeout"))||(null==(t=e.message)?void 0:t.includes("Network Error"))||!e.response)m=!1,Date.now();else if((null==(a=e.response)?void 0:a.status)===503){m=!0,f=!0;let n=null==(s=e.response)?void 0:s.data;p=(null==n?void 0:n.maintenance)||n||null,Date.now()}return(null==(r=e.response)?void 0:r.status)===401&&(y(),window.location.href="/login"),Promise.reject(e)});let O=()=>{let[e,n]=(0,s.useState)(d),[t,a]=(0,s.useState)(!0),[r,l]=(0,s.useState)(!1),[o,i]=(0,s.useState)(!1),[c,h]=(0,s.useState)(!1),[v,w]=(0,s.useState)(null),g=(0,u.useRouter)(),y=(0,s.useRef)(!0);(0,s.useEffect)(()=>()=>{y.current=!1},[]),(0,s.useEffect)(()=>{(async()=>{if(y.current)try{let e=await S();if(e.maintenanceMode){h(!0),w(e.maintenanceInfo||null),i(!1),l(!0),a(!1),g.push("/maintenance");return}if(e.serverError){i(!0),h(!1),w(null),l(!0),a(!1),g.push("/server-unreachable");return}let t=N(),r=d;if(t&&r){n(r),l(!0),a(!1),i(!1),h(!1),w(null);return}if(t&&!r)try{let e=await k();y.current&&(n(e),i(!m),h(f),w(p))}catch(e){i(!m),h(f),w(p)}y.current&&(l(!0),a(!1),i(!m),h(f),w(p))}catch(e){y.current&&(l(!0),a(!1),i(!0),h(f),w(p))}})()},[g]);let A=async(e,t)=>{let a=await _(e,t);if(a.serverError)return i(!0),h(!1),w(null),g.push("/server-unreachable"),a;if(a.maintenanceMode)return i(!1),h(!0),w(a.maintenanceInfo||null),g.push("/maintenance"),a;if("Login successful"===a.message&&a.user&&y.current){n(a.user),i(!1),h(!1),w(null);let e=E(a.user.role);g.push(e)}return a},D=async()=>{await R(),y.current&&(n(null),h(!1),w(null))},O=async()=>{a(!0);let e=await S();if(e.serverError)i(!0),h(!1),w(null),g.push("/server-unreachable");else if(e.maintenanceMode)i(!1),h(!0),w(e.maintenanceInfo||null),g.push("/maintenance");else if("Server is reachable"===e.message&&y.current&&(i(!1),h(!1),w(null),N()))try{let e=await k();n(e)}catch(e){console.warn("Failed to refresh user data after reconnection")}return y.current&&a(!1),e},C=async()=>{let e=await k();return y.current&&(n(e),i(!m),h(f),w(p)),e};return{user:e,isAuthenticated:N(),isLoading:t,authChecked:r,serverUnreachable:o,maintenanceMode:c,maintenanceDetails:v,login:A,logout:D,retryConnection:O,fetchUser:C,getRoleBasedRedirectUrl:E}},C=o}}]);